[![CI](https://github.com/markforster/Throttlade/actions/workflows/ci.yml/badge.svg)](https://github.com/markforster/Throttlade/actions/workflows/ci.yml)

# Throttlade

  <div>
    <img src="public/icons/apple-touch-icon.png" width="120" alt="Throttlade" 
  style="margin-right:30px;float:left;border-radius: 8px;" 
  /><div><p>Throttlade is a Chrome extension that lets you slow down (or “throttle”) HTTP requests so you can study loading behaviour, reproduce race conditions, and massage performance budgets. It ships with a friendly options dashboard for managing rules, live request/response monitoring, and log capture so you can keep an eye on what the extension is doing.</p></div>
  </div>
<div style="clear:both;"></div>

## Getting Started

### Requirements

- Node.js 18 or newer (the project currently runs on Node 20 in CI)
- npm (bundled with Node)

### Install Dependencies

```bash
npm install
```

### Run the build in watch mode

```bash
npm run dev
```

This runs esbuild in watch mode so the extension is recompiled as you edit source files.

### Run tests

```bash
npm test
```

Fast, verbose test run (no coverage/report). For coverage or HTML report:

```bash
# Coverage summary + lcov + HTML
npm run test:coverage

# Coverage + Jest HTML report (saved under reports/jest)
npm run test:report

# Watch mode (no coverage/report)
npm run test:watch
```

The project uses a TypeScript‑aware Jest configuration; no extra tooling is required.

## Loading the Extension in Chrome

1. Build the project (or run `npm run dev` to keep building incrementally).
2. Open `chrome://extensions` in Chrome.
3. Enable **Developer mode** (toggle in the top-right corner).
4. Click **Load unpacked** and choose the `dist/` directory.
5. The “Throttlade” extension should appear in your toolbar.

Whenever you rebuild, simply refresh the extension in the Extensions page.

## Project Structure

```
.
├── dist/                     # Build output (generated by esbuild)
├── docs/                     # Project documentation (designs, TODOs)
├── esbuild.config.mjs        # Bundler configuration
├── manifest.json             # Chrome extension manifest
├── public/                   # Static assets (icons)
├── scripts/                  # Small maintenance scripts
├── src/
│   ├── background/           # Background service worker modules
│   ├── components/           # React components for popup/options UIs
│   ├── content/              # Content script helpers (state sync, interceptors)
│   ├── hooks/                # Custom React hooks
│   ├── html/                 # Static HTML shells (popup, options)
│   ├── inpage/               # In-page scripts working with the content bridge
│   ├── theme/                # Bootstrap theme + custom styles
│   ├── types/                # Shared TypeScript types
│   └── utils/                # Shared utilities (rules, logging, throttling)
│       └── rules/            # Rules helpers (matching, shadowing analyzer)
└── tests/                    # Jest test suites and mocks
```

## npm Scripts

| Command             | Description                                                                                                                                          |
| ------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| `npm run dev`         | Start esbuild in watch mode (`--watch`) for incremental builds.                                                                 |
| `npm run build`       | Production build via esbuild.                                                                                                   |
| `npm run build:all`   | Build theme CSS then run the production build.                                                                                 |
| `npm run watch:theme` | Watch and rebuild the Bootstrap theme CSS.                                                                                     |
| `npm test`            | Fast, verbose Jest run (no coverage/report).                                                                                    |
| `npm run test:watch`  | Jest watch mode (no coverage/report).                                                                                           |
| `npm run test:coverage` | Jest with coverage (HTML + lcov under `reports/coverage`).                                                                   |
| `npm run test:report` | Jest with coverage and HTML test report (under `reports/jest`).                                                                |

> Tip: some scripts may be wrappers around `tsx`, `jest`, or direct `node` invocations. Inspect `package.json` if you need a refresher on what each script does behind the scenes.

## Extension Surfaces

- **Popup** (`src/components/app/popup.tsx`) lives in the Chrome action popup. It exposes quick toggles and status.
- **Options Dashboard** (`src/components/app/options.tsx`) is the main management UI. Navigate to `chrome-extension://<id>/options.html` or click “Options” in the extension menu.
- **Background Service Worker** (`src/background/`) keeps global state, handles runtime messages, and broadcasts updates to the UI.
- **Content Scripts** (`src/content/` and `src/inpage/`) wrap page network calls so throttling happens before requests leave the browser.

## Adding a New Build Surface

If you introduce a new UI view or script, remember the triangle:

1. Create your TypeScript entry file under `src/`.
2. Register it in `entryPoints` within `esbuild.config.mjs` so it gets bundled.
3. Add the compiled output to `manifest.json` under the appropriate field (`background`, `content_scripts`, `action.default_popup`, `options_page`, etc.).

A quick lookup table with the existing mapping is in `docs/esbuild-entrypoints.md`.

## Rule Shadowing Analyzer

The Options dashboard highlights rules that are shadowed by earlier rules:

- “Never matches” (definite): A higher‑priority rule is a proven superset of the later one (same/superset method, substring equality for wildcard; universal or contains‑literal regex for regex mode).
- “May not match” (possible): Heuristic overlap (e.g., broad `.*` regex or shared literal segments) where full containment isn’t proven.

Where you see it:
- Manage Order modal: Inline badges per rule and a live summary of total definite/possible conflicts as you drag to reorder.
- Rules table: A concise badge and tooltip per row (right‑aligned in the URL/Path column) with the first blocker and a short reason.

Design and implementation details live in `docs/rule-shadowing.md`. The analyzer code is under `src/utils/rules/analyze.ts` with unit tests in `tests/utils/rules/analyze.test.ts`.

## Troubleshooting

- **Tests fail to run due to Watchman**: Some sandboxed environments disable Watchman sockets. Add `--watchman false` or set `WATCHMAN_SOCK_PATH` to a temporary path when running `jest` manually.
- **Content scripts not updating**: After running `npm run dev`, refresh the extension via `chrome://extensions` to ensure Chrome picks up the rebuilt bundles.
- **Chrome complains about permissions**: Double-check `manifest.json` when adding new APIs—Chrome is strict about listed permissions and host match patterns.

## Contributing

Feel free to open issues or submit pull requests. Please run `npm test` and `npm run lint` before committing so the CI pipeline stays green.

Happy debugging!

## License

This project is licensed under the MIT License – see `LICENSE` for details.
